<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>FitTrack Pro</title>

  <style>
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif;
      background: radial-gradient(circle at 20% 10%, #1f2a44, #070a13 60%);
      color:#e5e7eb;
    }
    .container{max-width:1200px;margin:0 auto;padding:24px}
    header{
      display:flex;justify-content:space-between;align-items:center;gap:12px;
      padding:18px;border:1px solid rgba(148,163,184,.25);
      background: rgba(2,6,23,.6);
      border-radius:18px;
      box-shadow:0 20px 60px rgba(0,0,0,.35);
      margin-bottom:16px;
    }
    .brand{display:flex;gap:12px;align-items:center}
    .logo{
      width:48px;height:48px;border-radius:14px;
      background: linear-gradient(135deg,#4f46e5,#7c3aed);
      display:flex;align-items:center;justify-content:center;
      font-size:22px;
      box-shadow:0 10px 30px rgba(79,70,229,.35);
    }
    h1{margin:0;font-size:18px}
    .subtitle{opacity:.8;font-size:13px;margin-top:2px}
    .actions{display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end}
    .btn{
      border:none;cursor:pointer;
      padding:10px 12px;border-radius:12px;
      background: rgba(148,163,184,.12);
      color:#e5e7eb;
      border:1px solid rgba(148,163,184,.25);
      font-weight:700;
    }
    .btn.primary{
      background: linear-gradient(135deg,#4f46e5,#7c3aed);
      border: none;
      box-shadow:0 10px 25px rgba(79,70,229,.25);
    }
    .grid{
      display:grid;
      grid-template-columns: 1.2fr .8fr;
      gap:14px;
    }
    @media (max-width: 980px){
      .grid{grid-template-columns:1fr}
    }

    .tabs{
      display:flex;gap:10px;flex-wrap:wrap;
      margin:14px 0 14px;
    }
    .tab{
      padding:10px 12px;border-radius:12px;
      background: rgba(2,6,23,.55);
      border:1px solid rgba(148,163,184,.25);
      cursor:pointer;font-weight:800;font-size:13px;
      opacity:.85;
    }
    .tab.active{
      background: rgba(79,70,229,.22);
      border-color: rgba(79,70,229,.55);
      opacity:1;
    }

    .card{
      background: rgba(2,6,23,.60);
      border:1px solid rgba(148,163,184,.25);
      border-radius:18px;
      padding:16px;
      box-shadow:0 18px 50px rgba(0,0,0,.28);
    }
    .card h2{
      margin:0 0 10px;
      font-size:15px;
      display:flex;align-items:center;gap:8px
    }
    .muted{opacity:.75;font-size:13px;line-height:1.4}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .field{flex:1;min-width:160px}
    label{display:block;margin:10px 0 6px;font-weight:800;font-size:12px;opacity:.9;text-transform:uppercase;letter-spacing:.4px}
    input,select,textarea{
      width:100%;
      padding:10px 12px;border-radius:12px;
      background: rgba(0,0,0,.18);
      border:1px solid rgba(148,163,184,.25);
      color:#e5e7eb;
      outline:none;
    }
    textarea{min-height:90px;resize:vertical}

    .stats{
      display:grid;
      grid-template-columns: repeat(4, 1fr);
      gap:10px;
      margin-top:10px;
    }
    @media (max-width: 980px){
      .stats{grid-template-columns:repeat(2,1fr)}
    }
    .stat{
      padding:14px;border-radius:16px;
      background: rgba(148,163,184,.10);
      border:1px solid rgba(148,163,184,.18);
    }
    .stat .k{font-size:12px;opacity:.78;font-weight:800}
    .stat .v{font-size:22px;font-weight:900;margin-top:6px}

    .list{margin-top:10px;display:flex;flex-direction:column;gap:8px}
    .item{
      padding:12px;border-radius:14px;
      background: rgba(0,0,0,.18);
      border:1px solid rgba(148,163,184,.20);
      display:flex;justify-content:space-between;gap:10px;align-items:flex-start;
      font-size:13px;
    }
    .pill{
      padding:4px 8px;border-radius:999px;
      background: rgba(79,70,229,.22);
      border:1px solid rgba(79,70,229,.45);
      font-size:12px;font-weight:800;white-space:nowrap
    }
    .hidden{display:none !important}

    .toast{
      position:fixed;bottom:18px;right:18px;left:18px;
      max-width:720px;margin:0 auto;
      background: rgba(15,23,42,.92);
      border:1px solid rgba(148,163,184,.25);
      color:#e5e7eb;
      padding:12px 14px;border-radius:14px;
      box-shadow:0 20px 60px rgba(0,0,0,.35);
      display:none;
      white-space:pre-wrap;
    }
    .toast.show{display:block}
  </style>
</head>

<body>
  <div class="container">

    <header>
      <div class="brand">
        <div class="logo">üí™</div>
        <div>
          <h1>FitTrack Pro</h1>
          <div class="subtitle">BP synchronis√© Google Sheets ‚Ä¢ autres donn√©es locales (pour l‚Äôinstant)</div>
        </div>
      </div>

      <div class="actions">
        <button class="btn" onclick="openNames()">üë§ Noms</button>
        <button class="btn" onclick="reloadAll()">üîÑ Recharger</button>
        <button class="btn primary" onclick="setApi()">üîó API</button>
      </div>
    </header>

    <div class="tabs">
      <div class="tab active" data-tab="dashboard" onclick="showTab('dashboard')">üìä Dashboard</div>
      <div class="tab" data-tab="workouts" onclick="showTab('workouts')">üèÉ Workouts</div>
      <div class="tab" data-tab="meals" onclick="showTab('meals')">üçΩÔ∏è Meals</div>
      <div class="tab" data-tab="weight" onclick="showTab('weight')">‚öñÔ∏è Weight</div>
      <div class="tab" data-tab="bp" onclick="showTab('bp')">ü©∫ BP</div>
    </div>

    <div class="grid">
      <div>

        <div id="dashboard" class="card">
          <h2>üìä Dashboard</h2>
          <div class="muted" id="dashHint">Chargement‚Ä¶</div>
          <div class="stats">
            <div class="stat"><div class="k">Workouts (7 jours)</div><div class="v" id="s_workouts">‚Äî</div></div>
            <div class="stat"><div class="k">Minutes (7 jours)</div><div class="v" id="s_minutes">‚Äî</div></div>
            <div class="stat"><div class="k">Dernier poids</div><div class="v" id="s_weight">‚Äî</div></div>
            <div class="stat"><div class="k">Dernier BP</div><div class="v" id="s_bp">‚Äî</div></div>
          </div>
        </div>

        <div id="workouts" class="card hidden">
          <h2>üèÉ Log a Workout</h2>
          <div class="row">
            <div class="field"><label>Utilisateur</label><select id="w_user"></select></div>
            <div class="field"><label>Type</label>
              <select id="w_type">
                <option value="">Choisir‚Ä¶</option>
                <option>Abs</option><option>Weights</option><option>Cycling</option><option>Elliptical</option><option>Walking</option>
              </select>
            </div>
            <div class="field"><label>Dur√©e (min)</label><input id="w_duration" type="number" min="1"/></div>
            <div class="field"><label>Intensit√©</label><select id="w_intensity"><option>Low</option><option>Moderate</option><option>High</option></select></div>
          </div>
          <button class="btn primary" onclick="addWorkoutLocal()">‚úÖ Enregistrer (local)</button>
          <h2 style="margin-top:16px;">üìú Historique</h2>
          <div class="list" id="w_list"></div>
        </div>

        <div id="meals" class="card hidden">
          <h2>üçΩÔ∏è Log a Meal</h2>
          <div class="row">
            <div class="field"><label>Utilisateur</label><select id="m_user"></select></div>
            <div class="field"><label>Type</label><select id="m_type"><option value="">Choisir‚Ä¶</option><option>Breakfast</option><option>Lunch</option><option>Dinner</option><option>Snack</option></select></div>
            <div class="field"><label>Heure</label><input id="m_time" type="time"/></div>
          </div>
          <label>Description</label><textarea id="m_desc"></textarea>
          <button class="btn primary" onclick="addMealLocal()">‚úÖ Enregistrer (local)</button>
          <h2 style="margin-top:16px;">üìú Historique</h2>
          <div class="list" id="m_list"></div>
        </div>

        <div id="weight" class="card hidden">
          <h2>‚öñÔ∏è Log Weight</h2>
          <div class="row">
            <div class="field"><label>Utilisateur</label><select id="wt_user"></select></div>
            <div class="field"><label>Poids (kg)</label><input id="wt_value" type="number" step="0.1" min="30" max="300"/></div>
            <div class="field"><label>Date</label><input id="wt_date" type="date"/></div>
          </div>
          <button class="btn primary" onclick="addWeightLocal()">‚úÖ Enregistrer (local)</button>
          <h2 style="margin-top:16px;">üìú Historique</h2>
          <div class="list" id="wt_list"></div>
        </div>

        <div id="bp" class="card hidden">
          <h2>ü©∫ Log Blood Pressure</h2>
          <div class="row">
            <div class="field"><label>Utilisateur</label><select id="bp_user"></select></div>
            <div class="field"><label>Systolic</label><input id="bp_sys" type="number" min="70" max="250"/></div>
            <div class="field"><label>Diastolic</label><input id="bp_dia" type="number" min="40" max="150"/></div>
            <div class="field"><label>Heart Rate</label><input id="bp_hr" type="number" min="40" max="200"/></div>
          </div>
          <button class="btn primary" onclick="addBP()">‚úÖ Enregistrer (Google Sheet)</button>
          <h2 style="margin-top:16px;">üìú Historique BP</h2>
          <div class="list" id="bp_list"></div>
        </div>

      </div>

      <div class="card">
        <h2>üë• Vue</h2>
        <label>Afficher</label>
        <select id="viewUser" onchange="applyView()"></select>

        <div class="muted" style="margin-top:10px;">
          API : <span id="apiLabel" style="font-weight:900;"></span>
        </div>

        <button class="btn" style="margin-top:12px;" onclick="testApi()">üß™ Tester API</button>
        <button class="btn" style="margin-top:12px;" onclick="resetLocal()">üßπ Reset local</button>

        <div class="muted" style="margin-top:10px;">
          Note : Workouts/Meals/Weight sont locaux tant que ton Apps Script ne propose pas leurs actions.
        </div>
      </div>
    </div>

  </div>

  <div class="toast" id="toast"></div>

<script>
  const DEFAULT_API = "https://script.google.com/macros/s/AKfycbwvUseBbPVOq2gpXxkZftqh3XaDXNZQ_RxHCChx1TZG8ibxC9XwtDj1rnWIN-I6zVsdVw/exec";
  let API_URL = localStorage.getItem("fittrack_api") || DEFAULT_API;

  let names = JSON.parse(localStorage.getItem("fittrack_names") || '{"user1":"oly","user2":"sister"}');
  let currentView = localStorage.getItem("fittrack_view") || "all";

  let localData = JSON.parse(localStorage.getItem("fittrack_local") || '{"workouts":[],"meals":[],"weight":[]}');

  let bpData = []; // vient du Google Sheet via ?action=bp

  function toast(msg){
    const t = document.getElementById("toast");
    t.textContent = msg;
    t.classList.add("show");
    setTimeout(()=>t.classList.remove("show"), 3200);
  }

  function showTab(id){
    document.querySelectorAll(".tab").forEach(t=>t.classList.remove("active"));
    document.querySelector(`.tab[data-tab="${id}"]`).classList.add("active");
    ["dashboard","workouts","meals","weight","bp"].forEach(x=>{
      document.getElementById(x).classList.toggle("hidden", x !== id);
    });
  }

  function fillUsers(){
    const selects = ["w_user","m_user","wt_user","bp_user","viewUser"];
    selects.forEach(id=>{
      const el = document.getElementById(id);
      el.innerHTML = "";
      if(id === "viewUser"){
        el.insertAdjacentHTML("beforeend", `<option value="all">üìä Tout</option>`);
      }
      el.insertAdjacentHTML("beforeend", `<option value="user1">${names.user1}</option>`);
      el.insertAdjacentHTML("beforeend", `<option value="user2">${names.user2}</option>`);
    });
    document.getElementById("viewUser").value = currentView;
  }

  function applyView(){
    currentView = document.getElementById("viewUser").value;
    localStorage.setItem("fittrack_view", currentView);
    renderAll();
  }

  function openNames(){
    const u1 = prompt("Nom User 1 :", names.user1);
    if(u1 === null) return;
    const u2 = prompt("Nom User 2 :", names.user2);
    if(u2 === null) return;
    names = {user1: u1.trim() || "user1", user2: u2.trim() || "user2"};
    localStorage.setItem("fittrack_names", JSON.stringify(names));
    fillUsers();
    toast("Noms enregistr√©s ‚úÖ");
    renderAll();
  }

  function setApi(){
    const u = prompt("Colle ton URL Apps Script /exec :", API_URL);
    if(!u) return;
    API_URL = u.trim();
    localStorage.setItem("fittrack_api", API_URL);
    document.getElementById("apiLabel").textContent = API_URL;
    toast("API mise √† jour ‚úÖ");
    reloadAll();
  }

  function resetLocal(){
    if(!confirm("Reset local (noms + donn√©es locales) ?")) return;
    localStorage.removeItem("fittrack_names");
    localStorage.removeItem("fittrack_local");
    localStorage.removeItem("fittrack_view");
    names = {user1:"oly", user2:"sister"};
    currentView = "all";
    localData = {workouts:[],meals:[],weight:[]};
    fillUsers();
    toast("Reset local ‚úÖ");
    renderAll();
  }

  async function apiGet(params){
    const res = await fetch(API_URL + "?" + params, { method:"GET" });
    return await res.json();
  }
  async function apiPost(payload){
    const res = await fetch(API_URL, {
      method:"POST",
      headers:{ "Content-Type":"text/plain;charset=utf-8" },
      body: JSON.stringify(payload)
    });
    return await res.json();
  }

  async function testApi(){
    try{
      const r = await apiGet("");
      toast("API r√©pond ‚úÖ\n" + JSON.stringify(r, null, 2));
    }catch(e){
      toast("API KO ‚ùå\n" + String(e));
    }
  }

  function filterByView(arr){
    if(currentView === "all") return arr;
    return arr.filter(x => x.user === currentView);
  }

  function formatDate(d){
    try{
      const x = new Date(d);
      if(String(x) === "Invalid Date") return d;
      return x.toLocaleString();
    }catch(e){ return d; }
  }

  function renderDashboard(){
    const now = new Date();
    const weekAgo = new Date(now.getTime() - 7*24*60*60*1000);

    const workouts = filterByView(localData.workouts);
    const wWeek = workouts.filter(x => new Date(x.date) >= weekAgo);
    const minutes = wWeek.reduce((s,x)=> s + (Number(x.duration)||0), 0);

    const weights = filterByView(localData.weight);
    const lastWeight = weights.length ? weights[weights.length-1].value : "‚Äî";

    const bps = filterByView(bpData);
    const lastBP = bps.length ? `${bps[bps.length-1].systolic}/${bps[bps.length-1].diastolic}` : "‚Äî";

    document.getElementById("s_workouts").textContent = wWeek.length;
    document.getElementById("s_minutes").textContent = minutes;
    document.getElementById("s_weight").textContent = lastWeight;
    document.getElementById("s_bp").textContent = lastBP;

    document.getElementById("dashHint").textContent =
      currentView === "all" ? "Vue: tout le monde" : `Vue: ${names[currentView] || currentView}`;
  }

  function renderLists(){
    const w = filterByView(localData.workouts).slice().reverse().slice(0, 30);
    document.getElementById("w_list").innerHTML = w.length ? w.map(x=>`
      <div class="item">
        <div>
          <b>${names[x.user] || x.user}</b> ‚Äî ${x.type} ‚Ä¢ ${x.duration} min ‚Ä¢ ${x.intensity}
          <div class="muted">${formatDate(x.date)}</div>
        </div>
        <span class="pill">local</span>
      </div>
    `).join("") : `<div class="muted">Aucun workout.</div>`;

    const m = filterByView(localData.meals).slice().reverse().slice(0, 30);
    document.getElementById("m_list").innerHTML = m.length ? m.map(x=>`
      <div class="item">
        <div>
          <b>${names[x.user] || x.user}</b> ‚Äî ${x.type} ‚Ä¢ ${x.time || ""}
          <div class="muted">${x.description || ""}</div>
          <div class="muted">${x.date || ""}</div>
        </div>
        <span class="pill">local</span>
      </div>
    `).join("") : `<div class="muted">Aucun repas.</div>`;

    const wt = filterByView(localData.weight).slice().reverse().slice(0, 30);
    document.getElementById("wt_list").innerHTML = wt.length ? wt.map(x=>`
      <div class="item">
        <div>
          <b>${names[x.user] || x.user}</b> ‚Äî ${x.value} kg
          <div class="muted">${x.date || ""}</div>
        </div>
        <span class="pill">local</span>
      </div>
    `).join("") : `<div class="muted">Aucun poids.</div>`;

    const bp = filterByView(bpData).slice().reverse().slice(0, 30);
    document.getElementById("bp_list").innerHTML = bp.length ? bp.map(x=>`
      <div class="item">
        <div>
          <b>${names[x.user] || x.user}</b> ‚Äî ${x.systolic}/${x.diastolic} mmHg
          ${x.heartRate ? ` ‚Ä¢ ${x.heartRate} bpm` : ""}
          <div class="muted">${x.date || ""} ‚Ä¢ ${formatDate(x.timestamp || "")}</div>
        </div>
        <span class="pill">Google Sheet</span>
      </div>
    `).join("") : `<div class="muted">Aucun BP (sheet vide ou pas charg√©).</div>`;
  }

  function renderAll(){
    renderDashboard();
    renderLists();
  }

  function persistLocal(){
    localStorage.setItem("fittrack_local", JSON.stringify(localData));
  }

  function addWorkoutLocal(){
    const user = document.getElementById("w_user").value;
    const type = document.getElementById("w_type").value;
    const duration = Number(document.getElementById("w_duration").value || 0);
    const intensity = document.getElementById("w_intensity").value;
    if(!type || !duration) return alert("Remplis Type + Dur√©e.");
    localData.workouts.push({id:Date.now()+"", user, type, duration, intensity, date:new Date().toISOString()});
    persistLocal();
    toast("Workout local ‚úÖ");
    renderAll();
  }

  function addMealLocal(){
    const user = document.getElementById("m_user").value;
    const type = document.getElementById("m_type").value;
    const time = document.getElementById("m_time").value;
    const description = document.getElementById("m_desc").value;
    if(!type || !description) return alert("Remplis Type + Description.");
    localData.meals.push({id:Date.now()+"", user, type, time, description, date:new Date().toISOString().split("T")[0]});
    persistLocal();
    toast("Meal local ‚úÖ");
    renderAll();
  }

  function addWeightLocal(){
    const user = document.getElementById("wt_user").value;
    const value = Number(document.getElementById("wt_value").value || 0);
    const date = document.getElementById("wt_date").value || new Date().toISOString().split("T")[0];
    if(!value) return alert("Remplis le poids.");
    localData.weight.push({id:Date.now()+"", user, value, date, timestamp:new Date().toISOString()});
    persistLocal();
    toast("Poids local ‚úÖ");
    renderAll();
  }

  async function addBP(){
    try{
      const payload = {
        action: "bp_add",
        user: document.getElementById("bp_user").value,
        systolic: Number(document.getElementById("bp_sys").value || 0),
        diastolic: Number(document.getElementById("bp_dia").value || 0),
        heartRate: Number(document.getElementById("bp_hr").value || 0),
        date: new Date().toISOString().split("T")[0],
        timestamp: new Date().toISOString()
      };
      if(!payload.systolic || !payload.diastolic){
        alert("Remplis systolic + diastolic.");
        return;
      }
      const r = await apiPost(payload);
      if(!r.ok){
        toast("Erreur BP ‚ùå\n" + JSON.stringify(r,null,2));
        alert("Erreur: " + (r.error || "unknown"));
        return;
      }
      toast("BP enregistr√© ‚úÖ");
      await reloadAll();
    }catch(e){
      toast("Exception BP ‚ùå\n" + String(e));
      alert("Erreur technique: " + String(e));
    }
  }

  async function reloadAll(){
    toast("Chargement BP depuis Google Sheet‚Ä¶");
    try{
      const r = await apiGet("action=bp"); // IMPORTANT : ton API dit d‚Äôutiliser action=bp
      if(!r.ok){
        toast("Erreur load BP ‚ùå\n" + JSON.stringify(r,null,2));
        alert("Erreur API BP: " + (r.error || "unknown"));
        return;
      }
      // Selon ton script, √ßa peut √™tre rows ou data
      bpData = r.rows || r.data || [];
      toast("OK ‚úÖ BP charg√© (" + bpData.length + ")");
      renderAll();
    }catch(e){
      toast("Erreur r√©seau ‚ùå\n" + String(e));
      alert("Erreur r√©seau/API: " + String(e));
    }
  }

  (function boot(){
    document.getElementById("apiLabel").textContent = API_URL;
    fillUsers();
    const now = new Date();
    document.getElementById("m_time").value = now.toTimeString().slice(0,5);
    document.getElementById("wt_date").value = now.toISOString().split("T")[0];
    renderAll();
    reloadAll();
  })();
</script>
</body>
</html>
